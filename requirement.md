# Page Bot 需求

本文档旨在为 Page Bot Chrome 扩展提供一个全面的开发需求。
开发原则：模块化，遵循软件工程的最佳原则（如低耦合、高内聚），提高代码的可维护性、可读性和可扩展性，同时确保所有功能的完整实现。

## 1. 项目基本信息

- **项目名称**: Page Bot
- **目标平台**: Chrome 浏览器扩展 (Manifest V3)
- **核心功能**:
    - 通过浏览器侧边栏与当前网页内容进行 AI 对话。
    - 自动提取和解析网页主要内容。
    - 支持多种内容提取方式（如 Jina AI, Readability.js）。
    - 支持多种大型语言模型 (LLM) 服务（如 OpenAI API, Google Gemini）。
    - 支持多模态交互（如图片粘贴与发送）。
    - 用户配置的跨设备同步。
    - 流式响应以提供流畅的聊天体验。

## 2. UI 和交互设计


### 2.1 侧边栏

侧边栏界面保持垂直布局，主要包含以下区域：

1. **页面内容区**:
- 首行
    - 左侧：内容提取方式切换按钮（Jina, Readability，文本按钮）。
    - 右侧：包含内容复制和重新提取按钮。圆形
- 显示当前提取的网页内容（Markdown 格式）。 
- 区域高度可上下调整，不记忆用户设置，每次打开时使用设置的配置。 
- 加载状态：四个圆点跳动
 

2. **快捷输入区**:
- 根据配置，动态生成的用户可配置的快捷操作按钮。 
- 点击按钮直接发送消息
3. **聊天区域**:
- 展示用户与 AI 的对话历史。
- 支持 Markdown 渲染。
- 使用背景颜色区分用户消息和 AI 回复样式，全宽。
- 鼠标移到每条消息上，右侧显示浮动的复制文本按钮，复制markdown按钮，上下排列
- 支持 AI 回复的文本流式显示。
4. **输入区域**:
- 多行文本输入框，支持 `Shift+Enter` 换行。
    - 图片粘贴预览。
- 发送消息按钮。
- 清除对话历史按钮。
- 导出对话到 Markdown 文件按钮。
其他：
- 非文本按钮使用material design 图标，只导入用到的图标
 

### 2.2 配置页面

配置页面用于用户自定义扩展程序的行为，包括：

- 默认内容提取方式设置。
    - Jina AI API Key 及响应模板配置。
- LLM 提供商选择及各提供商的 API Key, Base URL, Model 等参数配置。
- 系统提示 (System Prompt) 配置。
- 快捷输入按钮管理。
- 内容显示区域默认高度设置。
- 缓存的页面数，对话数，清空按钮
- 同步缓存的页面数据到google drive

## 3. 交互流程

交互流程将基于重构后的模块化架构进行优化，确保各模块职责清晰，通信高效。

### 3.1 基本使用

1. 新页面点击扩展按钮
    - 页面是受限页面（如 Chrome 内部页面），则发送通知，不打开侧边栏
    - 有缓存则读取（区分提取方式的页面内容，对话历史）
    - 没有缓存使用配置的默认内容提取方式提取（等待页面加载完毕）
    - 提取完后写入缓存
2. 打开侧边栏的情况下，标签页切换
    - 自动关闭侧边栏    
3. 打开侧边栏的情况下，页面url变化
    - 等待页面加载完毕，之后等同于新页面逻辑


### 3.2 CHAT

1. 用户在侧边栏输入消息，可选粘贴图片。将用户消息（文本和 Base64 编码的图片，如有）打包发给大模型。
2. 大模型默认使用流式输出调用
3. 发送消息时，自动替换占位符 {PAGE} 为当前页面提取方式提取的内容文本。
    - 但UI显示替换前的消息。缓存时同时保存显示的内容和实际发送的内容。
4. 快捷输入区点击时直接发送消息，显示内容是配置的prompt，实际发送替换后的prompt


### 3.3 内容提取

1. 用户在侧边栏点击不同的内容提取方式按钮。默认从缓存读取，没有缓存则重新提取
2. 提取时，显示加载状态，所有按钮不可用
3. 点击重试按钮，强制重新提取
4. 提取完后自动更新缓存

提取方法：
1. **Jina AI 提取**:
- 支持免费服务和认证服务（API Key）
- 使用json返回格式
- 响应模板格式化: 支持配置中的自定义模板，使用占位符替换
    - 占位符：{title}, {description}, {url}, {content}

2. **Readability.js**: 
- 通过 Offscreen Document 处理DOM操作
- 使用Readability获取主要内容
- 使用markedjs/marked转换为 Markdown 格式
- 符合Manifest V3限制，避免在Service Worker中直接操作DOM

### 3.4 其他
- 本地页面缓存：自动淘汰最早访问页面

## 4 其他
- 注意chrome 扩展开发规范
- 使用 ES6 模块系统
- 职责分离: 每个模块有明确的单一职责
- 可重用性: 模块可以独立测试和重用
- 可维护性: 修改一个功能不会影响其他功能
- 方便增加大模型调用方式，内容提取方式
- 首次加载，使用默认配置的json文件
- 代码文件中只能使用英文
- 注释，日志只能使用英文



